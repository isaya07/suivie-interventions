import{_ as Se}from"./TrVZK8xw.js";import{y as ne,r as B,A as V,j as re,X as De,H as oe,Z as me,l as ae,g as W,o as E,w as y,b as d,C as fe,a as e,s as pe,d as K,t as m,i as z,h as X,c as j,n as Y,p as ue,k as ie,_ as ce,u as Ee,$ as Pe,a0 as Re}from"./DYlgVOq5.js";import ye from"./B20p3wMs.js";import Ie from"./TkXTV1AA.js";import Ae from"./C8iNwocK.js";import Be from"./Dbg5oWX5.js";import ve from"./D5k--mLm.js";import Ne from"./2TbVYi8k.js";import Ve from"./GLEe5mc8.js";import xe from"./8hyyyOHM.js";import{_ as Q}from"./DlAUqK2U.js";import{T as Me}from"./Bo_PBiFp.js";import{a as Le}from"./BlDxmV6q.js";import je from"./DHrzm7sw.js";import{s as qe}from"./HvkvFhBn.js";import Fe from"./7fFrN4_w.js";import{u as Ue}from"./CzSO0brV.js";import"./BG2qx38A.js";import"./jldlmTs4.js";import"./a_1wi9Nt.js";import"./Bjy1Ed27.js";import"./T8Rux-xW.js";import"./qGzjuHAM.js";import"./DyNxa_Fv.js";import"./CBaYzeil.js";import"./BEnwzTZz.js";const He=window.setInterval,ke=x=>{const{$api:c}=ne(),p=B(!1),$=B(null),T=B([]),r=B(0);let g=null;const I=async(s,_,R="")=>{try{const i=await c.post("/intervention_electrique.php?action=start_session",{intervention_id:x,phase:s,technicien_id:_,notes:R});if(i.success)return $.value=i.session,p.value=!0,r.value=0,O(),!0;throw new Error(i.message||"Erreur lors du démarrage de la session")}catch(i){throw console.error("Erreur startTimer:",i),i}},A=async(s="")=>{try{if(!$.value)throw new Error("Aucune session en cours");const _=await c.post("/intervention_electrique.php?action=stop_session",{session_id:$.value.id,notes:s});if(_.success)return q(),await D(),$.value=null,p.value=!1,r.value=0,!0;throw new Error(_.message||"Erreur lors de l'arrêt de la session")}catch(_){throw console.error("Erreur stopTimer:",_),_}},D=async()=>{try{const s=await c.get(`/intervention_electrique.php?action=get_sessions&intervention_id=${x}`);s.success&&(T.value=s.sessions||[])}catch(s){console.error("Erreur loadSessionHistory:",s),T.value=[]}},L=async()=>{try{const s=await c.get(`/intervention_electrique.php?action=get_active_session&intervention_id=${x}`);if(s.success&&s.session){$.value=s.session,p.value=!0;const _=new Date(s.session.debut),R=new Date;r.value=Math.floor((R-_)/1e3),O()}}catch(s){console.error("Erreur checkActiveSession:",s)}},O=()=>{g&&clearInterval(g),g=He(()=>{r.value++},1e3)},q=()=>{g&&(clearInterval(g),g=null)},F=s=>{const _=Math.floor(s/3600),R=Math.floor(s%3600/60),i=s%60;return`${_.toString().padStart(2,"0")}:${R.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`},C=s=>T.value.filter(i=>i.phase===s&&i.duree_minutes).reduce((i,b)=>i+(b.duree_minutes||0),0)/60,P=(s,_)=>C(s)*_,v=V(()=>F(r.value)),a=V(()=>$.value?.phase||null),n=V(()=>T.value.filter(s=>s.phase==="terrassement")),o=V(()=>T.value.filter(s=>s.phase==="branchement")),f=V(()=>C("terrassement")),t=V(()=>C("branchement"));return re(async()=>{await D(),await L()}),De(()=>{q()}),{isRunning:oe(p),currentSession:oe($),sessionHistory:oe(T),elapsedTime:oe(r),startTimer:I,stopTimer:A,loadSessionHistory:D,formatDuration:F,getTotalDuration:C,getTotalCost:P,formattedElapsedTime:v,currentPhase:a,terrassementSessions:n,branchementSessions:o,totalTerrassementDuration:f,totalBranchementDuration:t}},ze={class:"flex justify-between items-center p-4 border-b border-surface-200 dark:border-surface-700"},Oe={class:"flex items-center gap-3"},Xe={class:"text-lg font-semibold text-surface-900 dark:text-surface-50 capitalize"},Ye={key:0,class:"text-right"},We={class:"text-2xl font-mono font-bold text-primary-600 dark:text-primary-400"},Ge={class:"space-y-4"},Ze={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Je={class:"space-y-2"},Ke={class:"space-y-2"},Qe={class:"grid grid-cols-2 md:grid-cols-4 gap-4"},et={class:"text-center p-3 bg-surface-50 dark:bg-surface-800 rounded-lg"},tt={class:"text-xl font-bold text-surface-900 dark:text-surface-50"},st={class:"text-center p-3 bg-surface-50 dark:bg-surface-800 rounded-lg"},rt={class:"text-xl font-bold text-surface-900 dark:text-surface-50"},at={class:"text-center p-3 bg-surface-50 dark:bg-surface-800 rounded-lg"},nt={class:"text-xl font-bold text-surface-900 dark:text-surface-50"},ot={class:"text-center p-3 bg-surface-50 dark:bg-surface-800 rounded-lg"},it={class:"text-xl font-bold text-surface-900 dark:text-surface-50"},lt={class:"flex gap-3 justify-center"},ct={class:"space-y-2"},ut={class:"space-y-4"},dt={class:"space-y-2"},mt={class:"space-y-2"},ft={class:"flex gap-2 justify-end"},pt={class:"space-y-4"},vt={class:"text-surface-700 dark:text-surface-300"},xt={class:"space-y-2"},ht={class:"flex gap-2 justify-end"},gt={__name:"PhaseCard",props:{interventionId:{type:[String,Number],required:!0},phase:{type:String,required:!0,validator:x=>["terrassement","branchement"].includes(x)},phaseData:{type:Object,required:!0},techniciens:{type:Array,default:()=>[]},isActive:{type:Boolean,default:!1}},emits:["phase-updated"],setup(x,{emit:c}){const p=x,$=c,{$api:T}=ne(),r=me(),{isRunning:g,currentPhase:I,formattedElapsedTime:A,sessionHistory:D,startTimer:L,stopTimer:O,getTotalDuration:q,formatDuration:F}=ke(p.interventionId),C=B(p.phaseData.technicien_id),P=B(p.phaseData.notes||""),v=B(!1),a=B(!1),n=B(null),o=B(""),f=B(""),t=V(()=>p.phase==="terrassement"?"1":"2"),s=V(()=>p.phase==="terrassement"?"Terrassement":"Branchement électrique"),_=()=>p.isActive&&p.phaseData.statut==="en_attente"&&!g.value&&p.techniciens.length>0,R=()=>p.phaseData.statut==="terminee"?"Phase terminée":p.phaseData.statut==="annulee"?"Phase annulée":p.phaseData.statut==="en_cours"?"Reprendre session":"Démarrer session",i=()=>p.phaseData.statut==="en_cours"?"info":"success",b=()=>p.phase==="terrassement"?"pi pi-home":"pi pi-bolt",N=()=>{const k="text-white";return p.phase==="terrassement"?`${k} bg-orange-500`:`${k} bg-blue-500`},l=()=>g.value&&I.value===p.phase?"border-2 border-primary-400 shadow-lg":p.phaseData.statut==="terminee"?"border-l-4 border-green-400":p.phaseData.statut==="en_cours"?"border-l-4 border-blue-400":p.phaseData.statut==="annulee"?"border-l-4 border-red-400":"border-l-4 border-surface-300 dark:border-surface-600",u=k=>({en_attente:"En attente",en_cours:"En cours",terminee:"Terminée",annulee:"Annulée",non_applicable:"Non applicable"})[k]||k,w=k=>({en_attente:"warning",en_cours:"info",terminee:"success",annulee:"danger",non_applicable:"secondary"})[k]||"secondary",U=k=>D.value.filter(h=>h.phase===k).length,G=()=>(p.phase==="terrassement",4),M=async()=>{try{await L(p.phase,n.value,o.value),r.add({severity:"success",summary:"Session démarrée",detail:`Session de ${s.value.toLowerCase()} démarrée avec succès`,life:3e3}),o.value="",v.value=!1,$("phase-updated")}catch(k){r.add({severity:"error",summary:"Erreur",detail:k.message,life:5e3})}},Z=async()=>{try{await O(f.value),r.add({severity:"success",summary:"Session arrêtée",detail:`Session de ${s.value.toLowerCase()} arrêtée avec succès`,life:3e3}),f.value="",a.value=!1,$("phase-updated")}catch(k){r.add({severity:"error",summary:"Erreur",detail:k.message,life:5e3})}},ee=async()=>{try{const k=await T.post("/intervention_electrique.php?action=complete_phase",{intervention_id:p.interventionId,phase:p.phase});if(k.success)r.add({severity:"success",summary:"Phase terminée",detail:`Phase ${s.value.toLowerCase()} terminée avec succès`,life:3e3}),$("phase-updated");else throw new Error(k.message)}catch(k){r.add({severity:"error",summary:"Erreur",detail:k.message,life:5e3})}},te=async()=>{try{const k=await T.post("/intervention_electrique.php?action=assign_technicien",{intervention_id:p.interventionId,phase:p.phase,technicien_id:C.value});if(k.success)r.add({severity:"success",summary:"Technicien mis à jour",detail:"Technicien assigné avec succès",life:3e3}),$("phase-updated");else throw new Error(k.message)}catch(k){r.add({severity:"error",summary:"Erreur",detail:k.message,life:5e3}),C.value=p.phaseData.technicien_id}},se=async()=>{try{const k=await T.post("/intervention_electrique.php?action=update_notes",{intervention_id:p.interventionId,phase:p.phase,notes:P.value});if(!k.success)throw new Error(k.message)}catch{r.add({severity:"error",summary:"Erreur",detail:"Impossible de sauvegarder les notes",life:5e3})}},S=k=>k?new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(k):"-";return ae(()=>p.phaseData.technicien_id,k=>{C.value=k}),ae(()=>p.phaseData.notes,k=>{P.value=k||""}),re(()=>{p.phaseData.technicien_id&&(n.value=p.phaseData.technicien_id)}),(k,h)=>{const $e=xe,we=ue,he=Ve,Te=Ne,J=pe,de=ye,ge=fe,Ce=ve;return E(),W(Ce,{class:Y(["phase-card",l()])},{header:y(()=>[e("div",ze,[e("div",Oe,[d($e,{icon:b(),class:Y(N()),size:"large",shape:"circle"},null,8,["icon","class"]),e("div",null,[e("h3",Xe," Phase "+m(t.value)+": "+m(s.value),1),d(we,{value:u(x.phaseData.statut),severity:w(x.phaseData.statut),class:"mt-1"},null,8,["value","severity"])])]),z(g)&&z(I)===x.phase?(E(),j("div",Ye,[e("div",We,m(z(A)),1),h[11]||(h[11]=e("div",{class:"text-sm text-surface-600 dark:text-surface-400"}," Session en cours ",-1))])):X("",!0)])]),content:y(()=>[e("div",Ge,[e("div",Ze,[e("div",Je,[h[12]||(h[12]=e("label",{class:"text-sm font-medium text-surface-700 dark:text-surface-300"}," Technicien assigné ",-1)),d(he,{modelValue:C.value,"onUpdate:modelValue":h[0]||(h[0]=H=>C.value=H),options:x.techniciens,"option-label":"nom_complet","option-value":"id",placeholder:"Sélectionner un technicien",disabled:x.phaseData.statut==="terminee"||x.phaseData.statut==="annulee",class:"w-full",onChange:te},null,8,["modelValue","options","disabled"])]),e("div",Ke,[h[13]||(h[13]=e("label",{class:"text-sm font-medium text-surface-700 dark:text-surface-300"}," Taux horaire ",-1)),d(Te,{"model-value":S(x.phaseData.taux_horaire),readonly:"",class:"w-full"},null,8,["model-value"])])]),e("div",Qe,[e("div",et,[e("div",tt,m(z(F)(z(q)(x.phase)*3600)),1),h[14]||(h[14]=e("div",{class:"text-xs text-surface-600 dark:text-surface-400"}," Temps total ",-1))]),e("div",st,[e("div",rt,m(S(x.phaseData.cout)),1),h[15]||(h[15]=e("div",{class:"text-xs text-surface-600 dark:text-surface-400"}," Coût réel ",-1))]),e("div",at,[e("div",nt,m(U(x.phase)),1),h[16]||(h[16]=e("div",{class:"text-xs text-surface-600 dark:text-surface-400"}," Sessions ",-1))]),e("div",ot,[e("div",it,m(G())+"h ",1),h[17]||(h[17]=e("div",{class:"text-xs text-surface-600 dark:text-surface-400"}," Estimé ",-1))])]),e("div",lt,[!z(g)||z(I)!==x.phase?(E(),W(J,{key:0,label:R(),icon:"pi pi-play",severity:i(),disabled:!_(),onClick:h[1]||(h[1]=H=>v.value=!0)},null,8,["label","severity","disabled"])):X("",!0),z(g)&&z(I)===x.phase?(E(),W(J,{key:1,label:"Arrêter la session",icon:"pi pi-stop",severity:"danger",onClick:h[2]||(h[2]=H=>a.value=!0)})):X("",!0),x.phaseData.statut==="en_cours"&&(!z(g)||z(I)!==x.phase)?(E(),W(J,{key:2,label:"Terminer la phase",icon:"pi pi-check",severity:"success",onClick:ee})):X("",!0)]),e("div",ct,[h[18]||(h[18]=e("label",{class:"text-sm font-medium text-surface-700 dark:text-surface-300"}," Notes de la phase ",-1)),d(de,{modelValue:P.value,"onUpdate:modelValue":h[3]||(h[3]=H=>P.value=H),rows:"3",placeholder:"Ajoutez des notes pour cette phase...",class:"w-full",onBlur:se},null,8,["modelValue"])])])]),default:y(()=>[d(ge,{visible:v.value,"onUpdate:visible":h[7]||(h[7]=H=>v.value=H),modal:!0,closable:!0,header:"Démarrer une session de travail",class:"w-full max-w-md"},{footer:y(()=>[e("div",ft,[d(J,{label:"Annuler",severity:"secondary",onClick:h[6]||(h[6]=H=>v.value=!1)}),d(J,{label:"Démarrer",icon:"pi pi-play",severity:"success",disabled:!n.value,onClick:M},null,8,["disabled"])])]),default:y(()=>[e("div",ut,[e("div",dt,[h[19]||(h[19]=e("label",{class:"text-sm font-medium text-surface-700 dark:text-surface-300"}," Technicien ",-1)),d(he,{modelValue:n.value,"onUpdate:modelValue":h[4]||(h[4]=H=>n.value=H),options:x.techniciens,"option-label":"nom_complet","option-value":"id",placeholder:"Sélectionner un technicien",class:"w-full"},null,8,["modelValue","options"])]),e("div",mt,[h[20]||(h[20]=e("label",{class:"text-sm font-medium text-surface-700 dark:text-surface-300"}," Notes de démarrage (optionnel) ",-1)),d(de,{modelValue:o.value,"onUpdate:modelValue":h[5]||(h[5]=H=>o.value=H),rows:"3",placeholder:"Notes pour cette session...",class:"w-full"},null,8,["modelValue"])])])]),_:1},8,["visible"]),d(ge,{visible:a.value,"onUpdate:visible":h[10]||(h[10]=H=>a.value=H),modal:!0,closable:!0,header:"Arrêter la session de travail",class:"w-full max-w-md"},{footer:y(()=>[e("div",ht,[d(J,{label:"Continuer",severity:"secondary",onClick:h[9]||(h[9]=H=>a.value=!1)}),d(J,{label:"Arrêter",icon:"pi pi-stop",severity:"danger",onClick:Z})])]),default:y(()=>[e("div",pt,[e("p",vt,[h[21]||(h[21]=K(" Durée de la session : ",-1)),e("strong",null,m(z(A)),1)]),e("div",xt,[h[22]||(h[22]=e("label",{class:"text-sm font-medium text-surface-700 dark:text-surface-300"}," Notes finales (optionnel) ",-1)),d(de,{modelValue:f.value,"onUpdate:modelValue":h[8]||(h[8]=H=>f.value=H),rows:"3",placeholder:"Résumé du travail effectué...",class:"w-full"},null,8,["modelValue"])])])]),_:1},8,["visible"])]),_:1},8,["class"])}}},be=Q(gt,[["__scopeId","data-v-f3f76589"]]),bt={class:"session-history"},_t={class:"flex flex-col md:flex-row gap-4 mb-4"},yt={class:"flex-1"},kt={class:"flex-1"},$t={class:"flex gap-2"},wt={class:"flex items-center gap-2"},Tt={class:"font-medium"},Ct={class:"text-sm"},St={class:"font-medium"},Dt={class:"text-surface-600 dark:text-surface-400"},Et={key:0},Pt={class:"text-center"},Rt={class:"font-mono font-bold text-lg"},It={class:"text-xs text-surface-600 dark:text-surface-400"},At={class:"text-right font-medium"},Bt={class:"flex gap-1"},Nt={class:"text-center p-8"},Vt={class:"text-surface-600 dark:text-surface-400"},Mt={key:0,class:"space-y-6"},Lt={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},jt={class:"space-y-3"},qt={class:"text-surface-900 dark:text-surface-50"},Ft={class:"text-surface-900 dark:text-surface-50"},Ut={class:"space-y-3"},Ht={class:"text-surface-900 dark:text-surface-50 font-mono text-lg"},zt={class:"text-surface-900 dark:text-surface-50 font-medium"},Ot={class:"space-y-2"},Xt={class:"bg-surface-50 dark:bg-surface-800 p-4 rounded-lg"},Yt={class:"flex items-center gap-4 text-sm"},Wt={class:"flex items-center gap-2"},Gt={key:0,class:"flex items-center gap-2"},Zt={key:1,class:"flex items-center gap-2"},Jt={key:0,class:"space-y-2"},Kt={class:"bg-surface-50 dark:bg-surface-800 p-4 rounded-lg"},Qt={class:"text-surface-900 dark:text-surface-50 whitespace-pre-wrap"},es={class:"flex justify-end"},ts={__name:"SessionHistory",props:{sessions:{type:Array,default:()=>[]}},emits:["refresh"],setup(x,{emit:c}){const p=x,$=c,{$api:T}=ne(),r=me(),g=B([]),I=B([]),A=B(!1),D=B(null),L=[{label:"Terrassement",value:"terrassement"},{label:"Branchement",value:"branchement"}],O=V(()=>[...new Set(p.sessions.map(u=>u.technicien_nom))].filter(Boolean).map(u=>({label:u,value:u}))),q=V(()=>{let l=[...p.sessions];return g.value.length>0&&(l=l.filter(u=>g.value.includes(u.phase))),I.value.length>0&&(l=l.filter(u=>I.value.includes(u.technicien_nom))),l}),F=V(()=>g.value.length>0||I.value.length>0?"Aucune session ne correspond aux filtres sélectionnés":"Aucune session de travail enregistrée pour cette intervention"),C=()=>{},P=()=>{$("refresh"),r.add({severity:"info",summary:"Actualisation",detail:"Données actualisées",life:2e3})},v=l=>{D.value=l,A.value=!0},a=async l=>{try{const u=await T.post("/intervention_electrique.php?action=stop_session",{session_id:l.id,notes:"Session arrêtée depuis l'historique"});if(u.success)r.add({severity:"success",summary:"Session arrêtée",detail:"La session a été arrêtée avec succès",life:3e3}),$("refresh");else throw new Error(u.message)}catch(u){r.add({severity:"error",summary:"Erreur",detail:u.message,life:5e3})}},n=()=>{const u=[["Phase","Technicien","Début","Fin","Durée (min)","Coût estimé","Notes"].join(";"),...q.value.map(M=>[f(M.phase),M.technicien_nom||"",b(M.debut),M.fin?b(M.fin):"En cours",M.duree_minutes||0,o(M),(M.notes||"").replace(/"/g,'""')].map(Z=>`"${Z}"`).join(";"))].join(`
`),w=new Blob([u],{type:"text/csv;charset=utf-8;"}),U=document.createElement("a"),G=URL.createObjectURL(w);U.setAttribute("href",G),U.setAttribute("download",`sessions_intervention_${Date.now()}.csv`),U.style.visibility="hidden",document.body.appendChild(U),U.click(),document.body.removeChild(U),r.add({severity:"success",summary:"Export réussi",detail:"Le fichier CSV a été téléchargé",life:3e3})},o=l=>{if(!l.duree_minutes)return 0;const u=l.phase==="terrassement"?38:45;return l.duree_minutes/60*u},f=l=>l==="terrassement"?"Terrassement":"Branchement",t=l=>l==="terrassement"?"warning":"info",s=l=>l?l.split(" ").map(u=>u.charAt(0).toUpperCase()).join("").slice(0,2):"??",_=l=>{if(!l)return"00:00";const u=Math.floor(l/60),w=l%60;return`${u.toString().padStart(2,"0")}:${w.toString().padStart(2,"0")}`},R=l=>l?new Date(l).toLocaleDateString("fr-FR"):"-",i=l=>l?new Date(l).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}):"-",b=l=>l?new Date(l).toLocaleString("fr-FR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",N=l=>l?new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(l):"-";return(l,u)=>{const w=qe,U=pe,G=ue,M=je,Z=xe,ee=Le,te=fe,se=Me;return E(),j("div",bt,[e("div",_t,[e("div",yt,[d(w,{modelValue:g.value,"onUpdate:modelValue":u[0]||(u[0]=S=>g.value=S),options:L,"option-label":"label","option-value":"value",placeholder:"Filtrer par phase","max-selected-labels":2,class:"w-full",onChange:C},null,8,["modelValue"])]),e("div",kt,[d(w,{modelValue:I.value,"onUpdate:modelValue":u[1]||(u[1]=S=>I.value=S),options:O.value,"option-label":"label","option-value":"value",placeholder:"Filtrer par technicien","max-selected-labels":2,class:"w-full",onChange:C},null,8,["modelValue","options"])]),e("div",$t,[ie(d(U,{icon:"pi pi-refresh",severity:"secondary",onClick:P},null,512),[[se,"Actualiser"]]),ie(d(U,{icon:"pi pi-download",severity:"secondary",onClick:n},null,512),[[se,"Exporter CSV"]])])]),d(ee,{value:q.value,paginator:!0,rows:10,"rows-per-page-options":[10,25,50],"paginator-template":"RowsPerPageDropdown FirstPageLink PrevPageLink CurrentPageReport NextPageLink LastPageLink","current-page-report-template":"{first} à {last} sur {totalRecords} sessions","sort-field":"debut","sort-order":-1,"responsive-layout":"scroll","striped-rows":"",class:"w-full","empty-message":F.value},{empty:y(()=>[e("div",Nt,[u[4]||(u[4]=e("i",{class:"pi pi-clock text-4xl text-surface-400 dark:text-surface-600 mb-4"},null,-1)),u[5]||(u[5]=e("h3",{class:"text-lg font-medium text-surface-700 dark:text-surface-300 mb-2"}," Aucune session trouvée ",-1)),e("p",Vt,m(F.value),1)])]),default:y(()=>[d(M,{field:"phase",header:"Phase",sortable:"",class:"min-w-[120px]"},{body:y(({data:S})=>[d(G,{value:f(S.phase),severity:t(S.phase),class:"font-medium"},null,8,["value","severity"])]),_:1}),d(M,{field:"technicien_nom",header:"Technicien",sortable:"",class:"min-w-[150px]"},{body:y(({data:S})=>[e("div",wt,[d(Z,{label:s(S.technicien_nom),size:"small",shape:"circle",class:"bg-primary-100 text-primary-700"},null,8,["label"]),e("span",Tt,m(S.technicien_nom),1)])]),_:1}),d(M,{field:"debut",header:"Début",sortable:"",class:"min-w-[180px]"},{body:y(({data:S})=>[e("div",Ct,[e("div",St,m(R(S.debut)),1),e("div",Dt,[K(m(i(S.debut))+" ",1),S.fin?(E(),j("span",Et," - "+m(i(S.fin)),1)):X("",!0)])])]),_:1}),d(M,{field:"duree_minutes",header:"Durée",sortable:"",class:"min-w-[100px]"},{body:y(({data:S})=>[e("div",Pt,[e("div",Rt,m(_(S.duree_minutes)),1),e("div",It,m(S.duree_minutes||0)+" min ",1)])]),_:1}),d(M,{field:"cout_estime",header:"Coût estimé",sortable:"",class:"min-w-[120px]"},{body:y(({data:S})=>[e("div",At,m(N(o(S))),1)]),_:1}),d(M,{field:"fin",header:"Statut",class:"min-w-[100px]"},{body:y(({data:S})=>[d(G,{value:S.fin?"Terminée":"En cours",severity:S.fin?"success":"info"},null,8,["value","severity"])]),_:1}),d(M,{header:"Actions",class:"min-w-[80px]"},{body:y(({data:S})=>[e("div",Bt,[ie(d(U,{icon:"pi pi-eye",severity:"secondary",size:"small",onClick:k=>v(S)},null,8,["onClick"]),[[se,"Voir détails"]]),S.fin?X("",!0):ie((E(),W(U,{key:0,icon:"pi pi-stop",severity:"danger",size:"small",onClick:k=>a(S)},null,8,["onClick"])),[[se,"Arrêter session"]])])]),_:1})]),_:1},8,["value","empty-message"]),d(te,{visible:A.value,"onUpdate:visible":u[3]||(u[3]=S=>A.value=S),modal:!0,closable:!0,header:"Détails de la session",class:"w-full max-w-2xl"},{footer:y(()=>[e("div",es,[d(U,{label:"Fermer",severity:"secondary",onClick:u[2]||(u[2]=S=>A.value=!1)})])]),default:y(()=>[D.value?(E(),j("div",Mt,[e("div",Lt,[e("div",jt,[e("div",null,[u[6]||(u[6]=e("label",{class:"text-sm font-medium text-surface-700 dark:text-surface-300"},"Phase",-1)),e("p",qt,m(f(D.value.phase)),1)]),e("div",null,[u[7]||(u[7]=e("label",{class:"text-sm font-medium text-surface-700 dark:text-surface-300"},"Technicien",-1)),e("p",Ft,m(D.value.technicien_nom),1)])]),e("div",Ut,[e("div",null,[u[8]||(u[8]=e("label",{class:"text-sm font-medium text-surface-700 dark:text-surface-300"},"Durée",-1)),e("p",Ht,m(_(D.value.duree_minutes)),1)]),e("div",null,[u[9]||(u[9]=e("label",{class:"text-sm font-medium text-surface-700 dark:text-surface-300"},"Coût estimé",-1)),e("p",zt,m(N(o(D.value))),1)])])]),e("div",Ot,[u[13]||(u[13]=e("label",{class:"text-sm font-medium text-surface-700 dark:text-surface-300"},"Timeline",-1)),e("div",Xt,[e("div",Yt,[e("div",Wt,[u[10]||(u[10]=e("i",{class:"pi pi-play-circle text-green-600"},null,-1)),e("span",null,"Début: "+m(b(D.value.debut)),1)]),D.value.fin?(E(),j("div",Gt,[u[11]||(u[11]=e("i",{class:"pi pi-stop-circle text-red-600"},null,-1)),e("span",null,"Fin: "+m(b(D.value.fin)),1)])):(E(),j("div",Zt,u[12]||(u[12]=[e("i",{class:"pi pi-clock text-blue-600"},null,-1),e("span",null,"En cours...",-1)])))])])]),D.value.notes?(E(),j("div",Jt,[u[14]||(u[14]=e("label",{class:"text-sm font-medium text-surface-700 dark:text-surface-300"},"Notes",-1)),e("div",Kt,[e("p",Qt,m(D.value.notes),1)])])):X("",!0)])):X("",!0)]),_:1},8,["visible"])])}}},ss=Q(ts,[["__scopeId","data-v-ab7e22f7"]]),rs={class:"text-sm space-y-4"},as={class:"grid grid-cols-2 gap-4"},ns={class:"text-center p-3 bg-surface-50 dark:bg-surface-800 rounded-lg"},os={class:"text-lg font-bold text-surface-900 dark:text-surface-50"},is={class:"text-center p-3 bg-surface-50 dark:bg-surface-800 rounded-lg"},ls={class:"text-lg font-bold text-surface-900 dark:text-surface-50"},cs={class:"space-y-3"},us={class:"space-y-1"},ds={class:"flex justify-between text-sm"},ms={class:"space-y-1"},fs={class:"flex justify-between text-sm"},ps={class:"flex justify-between items-center pt-2 border-t border-surface-200 dark:border-surface-700"},vs={class:"flex items-center gap-2"},xs={class:"text-right"},hs={class:"text-sm font-medium text-surface-900 dark:text-surface-50"},gs={class:"flex items-center justify-between"},bs={class:"flex items-center gap-2"},_s={class:"font-medium text-surface-900 dark:text-surface-50"},ys={class:"text-right"},le=4,ks={__name:"PhaseDetailSummary",props:{phase:{type:String,required:!0,validator:x=>["terrassement","branchement"].includes(x)},duration:{type:Number,default:0},cost:{type:Number,default:0},estimatedCost:{type:Number,default:0},hourlyRate:{type:Number,required:!0},status:{type:String,default:"en_attente"}},setup(x){const c=x,p=V(()=>!c.duration||!le?0:(c.duration-le)/le*100),$=V(()=>!c.cost||!c.estimatedCost?0:(c.cost-c.estimatedCost)/c.estimatedCost*100),T=()=>c.duration?Math.min(c.duration/le*100,200):0,r=()=>!c.cost||!c.estimatedCost?0:Math.min(c.cost/c.estimatedCost*100,200),g=()=>{const t=p.value;return t>20?"progress-danger":t>10?"progress-warning":t<-10?"progress-success":"progress-info"},I=()=>{const t=$.value;return t>20?"progress-danger":t>10?"progress-warning":t<-10?"progress-success":"progress-info"},A=()=>{const t=p.value;return Math.abs(t)<1?"Conforme":`${t>0?"+":""}${t.toFixed(1)}%`},D=()=>{const t=$.value;return Math.abs(t)<1?"Conforme":`${t>0?"+":""}${t.toFixed(1)}%`},L=()=>{const t=p.value;return t>20?"text-red-600 dark:text-red-400":t>10?"text-orange-600 dark:text-orange-400":t<-10?"text-green-600 dark:text-green-400":"text-surface-700 dark:text-surface-300"},O=()=>{const t=$.value;return t>20?"text-red-600 dark:text-red-400":t>10?"text-orange-600 dark:text-orange-400":t<-10?"text-green-600 dark:text-green-400":"text-surface-700 dark:text-surface-300"},q=()=>({en_attente:"En attente",en_cours:"En cours",terminee:"Terminée",annulee:"Annulée",non_applicable:"Non applicable"})[c.status]||c.status,F=()=>({en_attente:"warning",en_cours:"info",terminee:"success",annulee:"danger",non_applicable:"secondary"})[c.status]||"secondary",C=()=>{if(c.status!=="terminee")return 0;const t=Math.max(0,200-T()),s=Math.max(0,200-r());return Math.round((t+s)/2)},P=()=>{const t=C();return t>=90?"Excellente performance":t>=75?"Bonne performance":t>=60?"Performance correcte":"Performance à améliorer"},v=()=>{const t=C();return t>=90?"pi pi-star-fill text-yellow-500":t>=75?"pi pi-thumbs-up text-green-600":t>=60?"pi pi-info-circle text-blue-600":"pi pi-exclamation-triangle text-orange-600"},a=()=>{const t=C();return t>=90?"text-yellow-600 dark:text-yellow-400":t>=75?"text-green-600 dark:text-green-400":t>=60?"text-blue-600 dark:text-blue-400":"text-orange-600 dark:text-orange-400"},n=()=>{const t=C();return t>=90?"border-yellow-200 bg-yellow-50 dark:border-yellow-800 dark:bg-yellow-950":t>=75?"border-green-200 bg-green-50 dark:border-green-800 dark:bg-green-950":t>=60?"border-blue-200 bg-blue-50 dark:border-blue-800 dark:bg-blue-950":"border-orange-200 bg-orange-50 dark:border-orange-800 dark:bg-orange-950"},o=t=>{if(!t)return"00:00";const s=Math.floor(t),_=Math.round((t-s)*60);return`${s.toString().padStart(2,"0")}:${_.toString().padStart(2,"0")}`},f=t=>t?new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(t):"-";return(t,s)=>{const _=Fe,R=ue;return E(),j("div",rs,[e("div",as,[e("div",ns,[e("div",os,m(o(x.duration)),1),s[0]||(s[0]=e("div",{class:"text-xs text-surface-600 dark:text-surface-400"}," Temps réel ",-1))]),e("div",is,[e("div",ls,m(f(x.cost)),1),s[1]||(s[1]=e("div",{class:"text-xs text-surface-600 dark:text-surface-400"}," Coût réel ",-1))])]),e("div",cs,[e("div",us,[e("div",ds,[s[2]||(s[2]=e("span",{class:"text-surface-700 dark:text-surface-300"},"Temps vs Estimé",-1)),e("span",{class:Y(["font-medium",L()])},m(A()),3)]),d(_,{value:T(),class:Y(g()),"show-value":!1},null,8,["value","class"])]),e("div",ms,[e("div",fs,[s[3]||(s[3]=e("span",{class:"text-surface-700 dark:text-surface-300"},"Coût vs Estimé",-1)),e("span",{class:Y(["font-medium",O()])},m(D()),3)]),d(_,{value:r(),class:Y(I()),"show-value":!1},null,8,["value","class"])])]),e("div",ps,[e("div",vs,[d(R,{value:q(),severity:F(),class:"text-xs"},null,8,["value","severity"])]),e("div",xs,[e("div",hs,m(f(x.hourlyRate))+"/h ",1),s[4]||(s[4]=e("div",{class:"text-xs text-surface-600 dark:text-surface-400"}," Taux horaire ",-1))])]),x.status==="terminee"?(E(),j("div",{key:0,class:Y(["mt-4 p-3 rounded-lg border",n()])},[e("div",gs,[e("div",bs,[e("i",{class:Y([v(),"text-lg"])},null,2),e("span",_s,m(P()),1)]),e("div",ys,[e("div",{class:Y(["text-sm font-bold",a()])},m(C())+"% ",3),s[5]||(s[5]=e("div",{class:"text-xs text-surface-600 dark:text-surface-400"}," Performance ",-1))])])],2)):X("",!0)])}}},_e=Q(ks,[["__scopeId","data-v-ecc8d2ed"]]),$s={class:"budget-comparison"},ws={class:"mb-6"},Ts={class:"space-y-3"},Cs={class:"flex justify-between items-center p-3 bg-surface-50 dark:bg-surface-800 rounded-lg"},Ss={class:"text-sm text-surface-600 dark:text-surface-400"},Ds={class:"text-right"},Es={class:"text-lg font-bold text-surface-900 dark:text-surface-50"},Ps={class:"text-sm text-surface-600 dark:text-surface-400"},Rs={class:"flex justify-between items-center p-3 bg-blue-50 dark:bg-blue-950 rounded-lg"},Is={class:"text-sm text-blue-700 dark:text-blue-300"},As={class:"text-right"},Bs={class:"text-lg font-bold text-blue-900 dark:text-blue-100"},Ns={class:"text-sm text-blue-700 dark:text-blue-300"},Vs={key:0,class:"flex justify-between items-center p-3 bg-orange-50 dark:bg-orange-950 rounded-lg"},Ms={class:"text-sm text-orange-700 dark:text-orange-300"},Ls={class:"text-right"},js={class:"text-lg font-bold text-orange-900 dark:text-orange-100"},qs={class:"text-sm text-orange-700 dark:text-orange-300"},Fs={class:"flex items-center justify-between"},Us={class:"flex items-center gap-2"},Hs={class:"font-medium text-surface-900 dark:text-surface-50"},zs={class:"text-sm text-surface-600 dark:text-surface-400"},Os={class:"text-right"},Xs={__name:"BudgetComparison",props:{estimatedTotal:{type:Number,default:0},realTotal:{type:Number,default:0},terrassementReal:{type:Number,default:0},branchementReal:{type:Number,default:0},hasTerrassement:{type:Boolean,default:!1}},setup(x){const c=x,p=B(null),$=V(()=>c.hasTerrassement?152:0),T=V(()=>180),r=V(()=>c.estimatedTotal?(c.realTotal-c.estimatedTotal)/c.estimatedTotal*100:0),g=V(()=>$.value?(c.terrassementReal-$.value)/$.value*100:0),I=V(()=>T.value?(c.branchementReal-T.value)/T.value*100:0),A=()=>{if(!p.value)return;const v=p.value,a=v.getContext("2d"),n=v.width,o=v.height,f={top:20,right:20,bottom:60,left:60},t=n-f.left-f.right,s=o-f.top-f.bottom,_=[];c.hasTerrassement&&_.push({label:"Terrassement",estimated:$.value,real:c.terrassementReal,color:"#f97316"}),_.push({label:"Branchement",estimated:T.value,real:c.branchementReal,color:"#3b82f6"});const R=Math.max(..._.flatMap(l=>[l.estimated,l.real]),0)*1.1;if(a.clearRect(0,0,n,o),R===0){a.fillStyle="#6b7280",a.font="16px sans-serif",a.textAlign="center",a.fillText("Aucune donnée",n/2,o/2);return}const i=t/(_.length*3);a.strokeStyle="#d1d5db",a.lineWidth=1,a.beginPath(),a.moveTo(f.left,f.top),a.lineTo(f.left,f.top+s),a.stroke(),a.beginPath(),a.moveTo(f.left,f.top+s),a.lineTo(f.left+t,f.top+s),a.stroke();const b=5;a.fillStyle="#6b7280",a.font="12px sans-serif",a.textAlign="right";for(let l=0;l<=b;l++){const u=R/b*l,w=f.top+s-s/b*l;a.strokeStyle="#f3f4f6",a.beginPath(),a.moveTo(f.left,w),a.lineTo(f.left+t,w),a.stroke(),a.fillText(new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(u),f.left-5,w+4)}_.forEach((l,u)=>{const w=f.left+(u+.5)*(t/_.length),U=w-i,G=w,M=l.estimated/R*s,Z=f.top+s-M;a.fillStyle=l.color+"80",a.fillRect(U,Z,i*.8,M);const ee=l.real/R*s,te=f.top+s-ee;a.fillStyle=l.color,a.fillRect(G,te,i*.8,ee),a.fillStyle="#374151",a.font="11px sans-serif",a.textAlign="center",a.fillText(P(l.estimated),U+i*.4,Z-5),a.fillText(P(l.real),G+i*.4,te-5),a.font="bold 12px sans-serif",a.fillText(l.label,w+i*.4,f.top+s+20)});const N=f.top+s+40;a.font="12px sans-serif",a.textAlign="left",a.fillStyle="#6b728080",a.fillRect(f.left,N,15,12),a.fillStyle="#374151",a.fillText("Estimé",f.left+20,N+9),a.fillStyle="#374151",a.fillRect(f.left+80,N,15,12),a.fillText("Réel",f.left+100,N+9)},D=()=>{const v=r.value;return Math.abs(v)<=5?"Budget maîtrisé":v>20?"Dépassement important":v>10?"Dépassement modéré":v>5?"Léger dépassement":v<-15?"Économie importante":v<-5?"Économie réalisée":"Écart minimal"},L=()=>{const v=r.value;return Math.abs(v)<=5?"Coûts conformes aux prévisions":v>20?"Révision nécessaire des estimations":v>10?"Surveillance des coûts recommandée":v>5?"Dépassement acceptable":v<-15?"Efficacité remarquable":v<-5?"Bon contrôle des coûts":"Performance équilibrée"},O=()=>{const v=Math.abs(r.value);return v<=5?"pi pi-check-circle text-green-600":v>20?"pi pi-exclamation-triangle text-red-600":v>10?"pi pi-info-circle text-orange-600":"pi pi-minus-circle text-blue-600"},q=()=>{const v=r.value;return Math.abs(v)<=5?"text-green-600 dark:text-green-400":v>20?"text-red-600 dark:text-red-400":v>10?"text-orange-600 dark:text-orange-400":"text-blue-600 dark:text-blue-400"},F=()=>{const v=Math.abs(r.value);return v<=5?"border-green-200 bg-green-50 dark:border-green-800 dark:bg-green-950":v>20?"border-red-200 bg-red-50 dark:border-red-800 dark:bg-red-950":v>10?"border-orange-200 bg-orange-50 dark:border-orange-800 dark:bg-orange-950":"border-blue-200 bg-blue-50 dark:border-blue-800 dark:bg-blue-950"},C=v=>Math.abs(v)<.1?"±0%":`${v>0?"+":""}${v.toFixed(1)}%`,P=v=>v?new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR",maximumFractionDigits:0}).format(v):"0€";return re(()=>{ce(()=>{A()})}),ae([()=>c.estimatedTotal,()=>c.realTotal,()=>c.terrassementReal,()=>c.branchementReal,()=>c.hasTerrassement],()=>{ce(()=>{A()})}),(v,a)=>(E(),j("div",$s,[e("div",ws,[e("canvas",{ref_key:"chartCanvas",ref:p,width:"400",height:"250",class:"w-full max-w-full h-auto"},null,512)]),e("div",Ts,[e("div",Cs,[e("div",null,[a[0]||(a[0]=e("div",{class:"font-medium text-surface-900 dark:text-surface-50"},"Total",-1)),e("div",Ss," Écart: "+m(C(r.value)),1)]),e("div",Ds,[e("div",Es,m(P(x.realTotal)),1),e("div",Ps," Estimé: "+m(P(x.estimatedTotal)),1)])]),e("div",Rs,[e("div",null,[a[1]||(a[1]=e("div",{class:"font-medium text-blue-900 dark:text-blue-100"},"Branchement",-1)),e("div",Is," Écart: "+m(C(I.value)),1)]),e("div",As,[e("div",Bs,m(P(x.branchementReal)),1),e("div",Ns," Estimé: "+m(P(T.value)),1)])]),x.hasTerrassement?(E(),j("div",Vs,[e("div",null,[a[2]||(a[2]=e("div",{class:"font-medium text-orange-900 dark:text-orange-100"},"Terrassement",-1)),e("div",Ms," Écart: "+m(C(g.value)),1)]),e("div",Ls,[e("div",js,m(P(x.terrassementReal)),1),e("div",qs," Estimé: "+m(P($.value)),1)])])):X("",!0)]),e("div",{class:Y(["mt-4 p-3 rounded-lg border",F()])},[e("div",Fs,[e("div",Us,[e("i",{class:Y([O(),"text-lg"])},null,2),e("div",null,[e("div",Hs,m(D()),1),e("div",zs,m(L()),1)])]),e("div",Os,[e("div",{class:Y(["text-xl font-bold",q()])},m(C(r.value)),3)])])],2)]))}},Ys=Q(Xs,[["__scopeId","data-v-6dbdad3b"]]),Ws={class:"intervention-summary"},Gs={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"},Zs={class:"text-center p-4"},Js={class:"flex justify-center mb-2"},Ks={class:"text-2xl font-bold text-surface-900 dark:text-surface-50 mb-1"},Qs={class:"text-xs text-surface-500 dark:text-surface-500 mt-1"},er={class:"text-center p-4"},tr={class:"flex justify-center mb-2"},sr={class:"text-2xl font-bold text-surface-900 dark:text-surface-50 mb-1"},rr={class:"text-xs text-surface-500 dark:text-surface-500 mt-1"},ar={class:"text-center p-4"},nr={class:"flex justify-center mb-2"},or={class:"text-xs text-surface-500 dark:text-surface-500 mt-1"},ir={class:"text-center p-4"},lr={class:"flex justify-center mb-2"},cr={class:"text-2xl font-bold text-surface-900 dark:text-surface-50 mb-1"},ur={class:"text-xs text-surface-500 dark:text-surface-500 mt-1"},dr={class:"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6"},mr={class:"grid grid-cols-1 lg:grid-cols-2 gap-6"},fr={class:"text-center"},pr={__name:"InterventionSummary",props:{intervention:{type:Object,default:()=>({})},totalTerrassementDuration:{type:Number,default:0},totalBranchementDuration:{type:Number,default:0}},setup(x){const c=x,p=B(null),$=V(()=>c.totalTerrassementDuration+c.totalBranchementDuration),T=V(()=>{let n=4;return r()&&(n+=4),n}),r=n=>c.intervention?.has_terrassement===!0,g=n=>c.intervention?.[`phase_${n}_cout`]||0,I=n=>4*(n==="terrassement"?38:45),A=()=>{if(!$.value||!T.value)return 100;const n=T.value/$.value*100;return Math.round(Math.min(n,150))},D=()=>{const n=A();return n>=120?"Excellent":n>=100?"Optimal":n>=80?"Correct":"À améliorer"},L=()=>{const n=c.intervention?.ecart_pourcentage||0;return n>10?"pi pi-exclamation-triangle":n>0?"pi pi-info-circle":n<-5?"pi pi-check-circle":"pi pi-minus-circle"},O=()=>{const n=c.intervention?.ecart_pourcentage||0;return n>10?"bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-300":n>0?"bg-orange-100 text-orange-600 dark:bg-orange-900 dark:text-orange-300":n<-5?"bg-green-100 text-green-600 dark:bg-green-900 dark:text-green-300":"bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-300"},q=()=>{const n=c.intervention?.ecart_pourcentage||0;return n>10?"text-red-600 dark:text-red-400":n>0?"text-orange-600 dark:text-orange-400":n<-5?"text-green-600 dark:text-green-400":"text-surface-900 dark:text-surface-50"},F=()=>{const n=c.intervention?.ecart_pourcentage||0;return`${n>0?"+":""}${n.toFixed(1)}%`},C=()=>{const n=c.intervention?.ecart_pourcentage||0;return n>10?"Dépassement important":n>5?"Dépassement modéré":n>0?"Léger dépassement":n<-10?"Économie importante":n<-5?"Économie modérée":n<0?"Légère économie":"Conforme au budget"},P=n=>{if(!n)return"00:00";const o=Math.floor(n),f=Math.round((n-o)*60);return`${o.toString().padStart(2,"0")}:${f.toString().padStart(2,"0")}`},v=n=>n?new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(n):"-",a=()=>{if(!p.value)return;const n=p.value,o=n.getContext("2d"),f=n.width/2,t=n.height/2,s=Math.min(f,t)-20,_=c.totalTerrassementDuration,R=c.totalBranchementDuration,i=_+R;if(i===0){o.clearRect(0,0,n.width,n.height),o.fillStyle="#6b7280",o.font="16px sans-serif",o.textAlign="center",o.fillText("Aucune donnée",f,t);return}const b={terrassement:"#f97316",branchement:"#3b82f6"};let N=-Math.PI/2;if(o.clearRect(0,0,n.width,n.height),_>0){const w=_/i*2*Math.PI;o.beginPath(),o.moveTo(f,t),o.arc(f,t,s,N,N+w),o.closePath(),o.fillStyle=b.terrassement,o.fill(),N+=w}if(R>0){const w=R/i*2*Math.PI;o.beginPath(),o.moveTo(f,t),o.arc(f,t,s,N,N+w),o.closePath(),o.fillStyle=b.branchement,o.fill()}const l=n.height-40;let u=20;_>0&&(o.fillStyle=b.terrassement,o.fillRect(u,l,15,15),o.fillStyle="#374151",o.font="12px sans-serif",o.textAlign="left",o.fillText(`Terrassement (${P(_)})`,u+20,l+12),u+=180),R>0&&(o.fillStyle=b.branchement,o.fillRect(u,l,15,15),o.fillStyle="#374151",o.font="12px sans-serif",o.fillText(`Branchement (${P(R)})`,u+20,l+12))};return re(()=>{ce(()=>{a()})}),ae([()=>c.totalTerrassementDuration,()=>c.totalBranchementDuration],()=>{ce(()=>{a()})}),(n,o)=>{const f=xe,t=ve;return E(),j("div",Ws,[e("div",Gs,[d(t,{class:"metric-card"},{content:y(()=>[e("div",Zs,[e("div",Js,[d(f,{icon:"pi pi-clock",class:"bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300",size:"large",shape:"circle"})]),e("div",Ks,m(P($.value)),1),o[0]||(o[0]=e("div",{class:"text-sm text-surface-600 dark:text-surface-400"}," Durée totale ",-1)),e("div",Qs," Estimé: "+m(T.value)+"h ",1)])]),_:1}),d(t,{class:"metric-card"},{content:y(()=>[e("div",er,[e("div",tr,[d(f,{icon:"pi pi-euro",class:"bg-green-100 text-green-600 dark:bg-green-900 dark:text-green-300",size:"large",shape:"circle"})]),e("div",sr,m(v(x.intervention?.cout_total_reel)),1),o[1]||(o[1]=e("div",{class:"text-sm text-surface-600 dark:text-surface-400"}," Coût total réel ",-1)),e("div",rr," Estimé: "+m(v(x.intervention?.cout_total_estime)),1)])]),_:1}),d(t,{class:"metric-card"},{content:y(()=>[e("div",ar,[e("div",nr,[d(f,{icon:L(),class:Y(O()),size:"large",shape:"circle"},null,8,["icon","class"])]),e("div",{class:Y(["text-2xl font-bold mb-1",q()])},m(F()),3),o[2]||(o[2]=e("div",{class:"text-sm text-surface-600 dark:text-surface-400"}," Écart budget ",-1)),e("div",or,m(C()),1)])]),_:1}),d(t,{class:"metric-card"},{content:y(()=>[e("div",ir,[e("div",lr,[d(f,{icon:"pi pi-chart-line",class:"bg-purple-100 text-purple-600 dark:bg-purple-900 dark:text-purple-300",size:"large",shape:"circle"})]),e("div",cr,m(A())+"% ",1),o[3]||(o[3]=e("div",{class:"text-sm text-surface-600 dark:text-surface-400"}," Efficacité ",-1)),e("div",ur,m(D()),1)])]),_:1})]),e("div",dr,[r()?(E(),W(t,{key:0},{header:y(()=>o[4]||(o[4]=[e("div",{class:"p-4 border-b border-surface-200 dark:border-surface-700"},[e("h4",{class:"text-lg font-semibold text-surface-900 dark:text-surface-50 flex items-center gap-2"},[e("i",{class:"pi pi-home text-orange-600"}),K(" Phase Terrassement ")])],-1)])),content:y(()=>[d(_e,{phase:"terrassement",duration:x.totalTerrassementDuration,cost:g("terrassement"),"estimated-cost":I("terrassement"),"hourly-rate":38,status:x.intervention?.phase_terrassement_statut},null,8,["duration","cost","estimated-cost","status"])]),_:1})):X("",!0),d(t,null,{header:y(()=>o[5]||(o[5]=[e("div",{class:"p-4 border-b border-surface-200 dark:border-surface-700"},[e("h4",{class:"text-lg font-semibold text-surface-900 dark:text-surface-50 flex items-center gap-2"},[e("i",{class:"pi pi-bolt text-blue-600"}),K(" Phase Branchement ")])],-1)])),content:y(()=>[d(_e,{phase:"branchement",duration:x.totalBranchementDuration,cost:g("branchement"),"estimated-cost":I("branchement"),"hourly-rate":45,status:x.intervention?.phase_branchement_statut},null,8,["duration","cost","estimated-cost","status"])]),_:1})]),e("div",mr,[d(t,null,{header:y(()=>o[6]||(o[6]=[e("div",{class:"p-4 border-b border-surface-200 dark:border-surface-700"},[e("h4",{class:"text-lg font-semibold text-surface-900 dark:text-surface-50"}," Répartition du temps ")],-1)])),content:y(()=>[e("div",fr,[e("canvas",{ref_key:"timeChartCanvas",ref:p,width:"300",height:"300",class:"max-w-full h-auto"},null,512)])]),_:1}),d(t,null,{header:y(()=>o[7]||(o[7]=[e("div",{class:"p-4 border-b border-surface-200 dark:border-surface-700"},[e("h4",{class:"text-lg font-semibold text-surface-900 dark:text-surface-50"}," Comparaison budgétaire ")],-1)])),content:y(()=>[d(Ys,{"estimated-total":x.intervention?.cout_total_estime,"real-total":x.intervention?.cout_total_reel,"terrassement-real":g("terrassement"),"branchement-real":g("branchement"),"has-terrassement":r("terrassement")},null,8,["estimated-total","real-total","terrassement-real","branchement-real","has-terrassement"])]),_:1})])])}}},vr=Q(pr,[["__scopeId","data-v-cff88214"]]),xr={class:"intervention-electrique"},hr={class:"flex justify-between items-center p-4 border-b border-surface-200 dark:border-surface-700"},gr={class:"text-2xl font-bold text-surface-900 dark:text-surface-50"},br={class:"text-surface-600 dark:text-surface-400 mt-1"},_r={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"},yr={class:"space-y-2"},kr={class:"text-surface-900 dark:text-surface-50"},$r={class:"space-y-2"},wr={class:"text-surface-900 dark:text-surface-50"},Tr={class:"space-y-2"},Cr={class:"text-surface-900 dark:text-surface-50 font-medium"},Sr={class:"space-y-2"},Dr={key:0,class:"text-sm ml-1"},Er={class:"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6"},Pr={__name:"InterventionElectrique",props:{interventionId:{type:[String,Number],required:!0}},emits:["intervention-updated"],setup(x,{emit:c}){const p=x,$=c,{$api:T}=ne(),r=B(null),g=B([]),I=B(!1),A=B(null),{sessionHistory:D,loadSessionHistory:L,totalTerrassementDuration:O,totalBranchementDuration:q}=ke(p.interventionId),F=V(()=>g.value.filter(i=>i.specialite_principale==="terrassier")),C=V(()=>g.value.filter(i=>i.specialite_principale==="cableur")),P=async()=>{I.value=!0,A.value=null;try{const i=await T.get(`/intervention_electrique.php?action=get&id=${p.interventionId}`);if(i.success)r.value=i.intervention,$("intervention-updated",r.value);else throw new Error(i.message||"Erreur lors du chargement de l'intervention")}catch(i){A.value=i.message,console.error("Erreur loadIntervention:",i)}finally{I.value=!1}},v=async()=>{try{const i=await T.get("/users.php?action=list&role=technicien");i.success&&(g.value=i.users||[])}catch(i){console.error("Erreur loadTechniciens:",i),g.value=[]}},a=i=>r.value?.has_terrassement===!0,n=i=>{if(!r.value)return{};const b=`phase_${i}_`;return{statut:r.value[`${b}statut`],technicien_id:r.value[`${b}technicien_id`],technicien_nom:r.value[`technicien_${i}_nom`],taux_horaire:r.value[`${b}taux_horaire`],date_debut:r.value[`${b}date_debut`],date_fin:r.value[`${b}date_fin`],duree_heures:r.value[`${b}duree_heures`],cout:r.value[`${b}cout`],notes:r.value[`${b}notes`]}},o=i=>r.value?i==="terrassement"?r.value.phase_terrassement_statut==="en_attente":i==="branchement"?(!a()||r.value.phase_terrassement_statut==="terminee")&&r.value.phase_branchement_statut==="en_attente":!1:!1,f=()=>{if(!r.value)return"En attente";const i=r.value.phase_branchement_statut==="terminee",b=!a()||r.value.phase_terrassement_statut==="terminee";return i&&b?"Terminée":r.value.phase_branchement_statut==="en_cours"||r.value.phase_terrassement_statut==="en_cours"?"En cours":r.value.phase_branchement_statut==="annulee"||r.value.phase_terrassement_statut==="annulee"?"Annulée":"En attente"},t=i=>{switch(i){case"Terminée":return"success";case"En cours":return"info";case"Annulée":return"danger";default:return"warning"}},s=i=>i?i>10?"text-red-600 dark:text-red-400":i>0?"text-orange-600 dark:text-orange-400":i<-5?"text-green-600 dark:text-green-400":"":"",_=i=>i?new Date(i).toLocaleDateString("fr-FR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}):"-",R=i=>i?new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(i):"-";return re(async()=>{await Promise.all([P(),v(),L()])}),(i,b)=>{const N=ue,l=ve;return E(),j("div",xr,[d(l,{class:"mb-6"},{header:y(()=>[e("div",hr,[e("div",null,[e("h2",gr," Intervention Électrique #"+m(r.value?.numero),1),e("p",br,m(r.value?.type_prestation_nom),1)]),d(N,{value:f(),severity:t(f()),class:"text-sm font-medium"},null,8,["value","severity"])])]),content:y(()=>[e("div",_r,[e("div",yr,[b[0]||(b[0]=e("label",{class:"text-sm font-medium text-surface-700 dark:text-surface-300"},"Client",-1)),e("p",kr,m(r.value?.client_nom),1)]),e("div",$r,[b[1]||(b[1]=e("label",{class:"text-sm font-medium text-surface-700 dark:text-surface-300"},"Date prévue",-1)),e("p",wr,m(_(r.value?.date_intervention)),1)]),e("div",Tr,[b[2]||(b[2]=e("label",{class:"text-sm font-medium text-surface-700 dark:text-surface-300"},"Coût estimé",-1)),e("p",Cr,m(R(r.value?.cout_total_estime)),1)]),e("div",Sr,[b[3]||(b[3]=e("label",{class:"text-sm font-medium text-surface-700 dark:text-surface-300"},"Coût réel",-1)),e("p",{class:Y(["text-surface-900 dark:text-surface-50 font-medium",s(r.value?.ecart_pourcentage)])},[K(m(R(r.value?.cout_total_reel))+" ",1),r.value?.ecart_pourcentage?(E(),j("span",Dr," ("+m(r.value.ecart_pourcentage>0?"+":"")+m(r.value.ecart_pourcentage)+"%) ",1)):X("",!0)],2)])])]),_:1}),e("div",Er,[a()?(E(),W(be,{key:0,"intervention-id":x.interventionId,phase:"terrassement","phase-data":n("terrassement"),techniciens:F.value,"is-active":o("terrassement"),onPhaseUpdated:P},null,8,["intervention-id","phase-data","techniciens","is-active"])):X("",!0),d(be,{"intervention-id":x.interventionId,phase:"branchement","phase-data":n("branchement"),techniciens:C.value,"is-active":o("branchement"),onPhaseUpdated:P},null,8,["intervention-id","phase-data","techniciens","is-active"])]),d(l,{class:"mb-6"},{header:y(()=>b[4]||(b[4]=[e("div",{class:"p-4 border-b border-surface-200 dark:border-surface-700"},[e("h3",{class:"text-lg font-semibold text-surface-900 dark:text-surface-50"}," Historique des sessions de travail ")],-1)])),content:y(()=>[d(ss,{sessions:z(D),onRefresh:z(L)},null,8,["sessions","onRefresh"])]),_:1}),d(l,null,{header:y(()=>b[5]||(b[5]=[e("div",{class:"p-4 border-b border-surface-200 dark:border-surface-700"},[e("h3",{class:"text-lg font-semibold text-surface-900 dark:text-surface-50"}," Résumé financier ")],-1)])),content:y(()=>[d(vr,{intervention:r.value,"total-terrassement-duration":z(O),"total-branchement-duration":z(q)},null,8,["intervention","total-terrassement-duration","total-branchement-duration"])]),_:1})])}}},Rr=Q(Pr,[["__scopeId","data-v-2c6569b5"]]),Ir={class:"max-w-7xl mx-auto p-4"},Ar={key:1,class:"text-surface-600 dark:text-surface-400"},Br={key:1,class:"flex justify-center items-center min-h-64"},Nr={key:2},Vr={class:"flex flex-wrap gap-3 mt-8 justify-between"},Mr={class:"flex gap-3"},Lr={class:"flex gap-3"},jr={key:3,class:"text-center py-12"},qr={class:"space-y-4"},Fr={class:"space-y-2"},Ur={class:"flex gap-2 justify-end"},Hr={__name:"[id]",setup(x){const c=Pe(),p=Re(),$=Ee(),T=me(),{$api:r}=ne(),g=B(null),I=B(!0),A=B(null),D=B(!1),L=B(""),O=V(()=>[{label:"Accueil",route:"/dashboard"},{label:"Interventions",route:"/interventions"},{label:`Intervention électrique #${g.value?.numero||c.params.id}`}]),q=V(()=>$.hasPermission("technicien")&&g.value&&["en_attente","en_cours"].includes(g.value.statut_global)),F=V(()=>$.hasPermission("manager")&&g.value&&g.value.phase_branchement_statut==="terminee"&&(!g.value.has_terrassement||g.value.phase_terrassement_statut==="terminee")),C=async()=>{I.value=!0,A.value=null;try{const t=await r.get(`/intervention_electrique.php?action=get&id=${c.params.id}`);if(t.success)g.value=t.intervention,g.value?.numero&&Ue({title:`Intervention électrique #${g.value.numero}`});else throw new Error(t.message||"Intervention non trouvée")}catch(t){A.value=t.message,console.error("Erreur loadIntervention:",t),g.value=null}finally{I.value=!1}},P=t=>{g.value=t,T.add({severity:"info",summary:"Intervention mise à jour",detail:"Les données ont été actualisées",life:2e3})},v=()=>{p.push("/interventions")},a=()=>{p.push(`/interventions/edit/${c.params.id}`)},n=()=>{D.value=!0},o=async()=>{try{const t=await r.post("/intervention_electrique.php?action=complete",{intervention_id:c.params.id,notes:L.value});if(t.success)T.add({severity:"success",summary:"Intervention terminée",detail:"L'intervention a été marquée comme terminée avec succès",life:5e3}),await C(),D.value=!1,L.value="";else throw new Error(t.message)}catch(t){T.add({severity:"error",summary:"Erreur",detail:t.message,life:5e3})}},f=()=>{const t=`/interventions/electrique/${c.params.id}/report`;window.open(t,"_blank","width=800,height=600")};return re(()=>{C()}),ae(()=>c.params.id,()=>{c.params.id&&C()}),(t,s)=>{const _=Se,R=Be,i=Ae,b=Ie,N=pe,l=ye,u=fe;return E(),j("div",Ir,[d(R,{model:O.value,class:"mb-6"},{item:y(({item:w})=>[w.route?(E(),W(_,{key:0,to:w.route,class:"text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-200"},{default:y(()=>[K(m(w.label),1)]),_:2},1032,["to"])):(E(),j("span",Ar,m(w.label),1))]),_:1},8,["model"]),A.value?(E(),W(i,{key:0,severity:"error",closable:!0,class:"mb-6",onClose:s[0]||(s[0]=w=>A.value=null)},{default:y(()=>[K(m(A.value),1)]),_:1})):X("",!0),I.value?(E(),j("div",Br,[d(b)])):g.value?(E(),j("div",Nr,[d(Rr,{"intervention-id":z(c).params.id,onInterventionUpdated:P},null,8,["intervention-id"]),e("div",Vr,[e("div",Mr,[d(N,{label:"Retour à la liste",icon:"pi pi-arrow-left",severity:"secondary",onClick:v}),d(N,{label:"Imprimer rapport",icon:"pi pi-print",severity:"secondary",onClick:f})]),e("div",Lr,[q.value?(E(),W(N,{key:0,label:"Modifier",icon:"pi pi-pencil",onClick:a})):X("",!0),F.value?(E(),W(N,{key:1,label:"Terminer intervention",icon:"pi pi-check",severity:"success",onClick:n})):X("",!0)])])])):(E(),j("div",jr,[s[4]||(s[4]=e("i",{class:"pi pi-exclamation-triangle text-6xl text-surface-400 dark:text-surface-600 mb-4"},null,-1)),s[5]||(s[5]=e("h2",{class:"text-2xl font-bold text-surface-700 dark:text-surface-300 mb-2"}," Intervention non trouvée ",-1)),s[6]||(s[6]=e("p",{class:"text-surface-600 dark:text-surface-400 mb-6"}," L'intervention demandée n'existe pas ou n'est plus accessible. ",-1)),d(N,{label:"Retour à la liste",icon:"pi pi-arrow-left",onClick:v})])),d(u,{visible:D.value,"onUpdate:visible":s[3]||(s[3]=w=>D.value=w),modal:!0,closable:!0,header:"Terminer l'intervention",class:"w-full max-w-md"},{footer:y(()=>[e("div",Ur,[d(N,{label:"Annuler",severity:"secondary",onClick:s[2]||(s[2]=w=>D.value=!1)}),d(N,{label:"Terminer",icon:"pi pi-check",severity:"success",onClick:o})])]),default:y(()=>[e("div",qr,[s[8]||(s[8]=e("p",{class:"text-surface-700 dark:text-surface-300"}," Êtes-vous sûr de vouloir marquer cette intervention comme terminée ? ",-1)),s[9]||(s[9]=e("p",{class:"text-sm text-surface-600 dark:text-surface-400"}," Cette action clôturera définitivement l'intervention et calculera les coûts finaux. ",-1)),e("div",Fr,[s[7]||(s[7]=e("label",{class:"text-sm font-medium text-surface-700 dark:text-surface-300"}," Notes finales (optionnel) ",-1)),d(l,{modelValue:L.value,"onUpdate:modelValue":s[1]||(s[1]=w=>L.value=w),rows:"3",placeholder:"Résumé final, observations...",class:"w-full"},null,8,["modelValue"])])])]),_:1},8,["visible"])])}}},xa=Q(Hr,[["__scopeId","data-v-405d5949"]]);export{xa as default};
