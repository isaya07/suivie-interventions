import{_ as ne}from"./TrVZK8xw.js";import{T as re}from"./Bo_PBiFp.js";import{a as ae}from"./BlDxmV6q.js";import{e as oe,u as le,Z as ie,y as ce,r as h,A as L,j as ue,c as v,a as n,b as r,g as V,w as l,s as me,o as c,d as de,t as i,h as x,p as pe,n as _e,k as N}from"./DYlgVOq5.js";import fe from"./DHrzm7sw.js";import he from"./TkXTV1AA.js";import ve from"./D5k--mLm.js";import{s as xe}from"./HvkvFhBn.js";import ye from"./2TbVYi8k.js";import{_ as be}from"./DlAUqK2U.js";import"./Bjy1Ed27.js";import"./a_1wi9Nt.js";import"./T8Rux-xW.js";import"./qGzjuHAM.js";import"./BG2qx38A.js";import"./DyNxa_Fv.js";import"./CBaYzeil.js";import"./jldlmTs4.js";import"./BEnwzTZz.js";const ge={class:"interventions-electriques-page"},ke={class:"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6"},Ce={class:"flex gap-3 mt-4 sm:mt-0"},we={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"},Te={class:"space-y-2"},Se={class:"space-y-2"},Ee={class:"space-y-2"},$e={class:"space-y-2"},Le={class:"flex flex-wrap gap-2 mt-4 pt-4 border-t border-surface-200 dark:border-surface-700"},Ve={key:0,class:"flex justify-center items-center py-12"},Ne={class:"font-medium text-surface-900 dark:text-surface-50"},Re={class:"text-sm text-surface-600 dark:text-surface-400"},Ae={class:"space-y-1"},Be={key:0,class:"flex items-center gap-2"},De={key:0,class:"text-xs text-surface-600 dark:text-surface-400"},qe={class:"flex items-center gap-2"},Pe={key:0,class:"text-xs text-surface-600 dark:text-surface-400"},Ie={class:"text-center"},ze={class:"font-mono font-bold text-surface-900 dark:text-surface-50"},Me={class:"text-sm font-medium text-surface-900 dark:text-surface-50"},Ue={class:"text-sm"},je={class:"font-medium"},Fe={class:"text-surface-600 dark:text-surface-400"},Oe={class:"flex gap-1"},Ge={class:"text-center p-8"},He={class:"text-surface-600 dark:text-surface-400 mb-4"},Ze={__name:"index",setup(Je){const g=oe(),R=le(),A=ie(),{$api:M}=ce(),k=h([]),w=h(!0),p=h(""),_=h([]),f=h([]),m=h([]),U=[{label:"En attente",value:"en_attente"},{label:"En cours",value:"en_cours"},{label:"Terminée",value:"terminee"},{label:"Annulée",value:"annulee"}],j=[{label:"Branchement seul",value:"BRANCHEMENT_SEUL"},{label:"Branchement avec terrassement",value:"BRANCHEMENT_TERRASSEMENT"}],F=L(()=>{const e=new Set;return k.value.forEach(t=>{t.technicien_branchement_nom&&e.add(t.technicien_branchement_nom),t.technicien_terrassement_nom&&e.add(t.technicien_terrassement_nom)}),Array.from(e).map(t=>({label:t,value:t}))}),B=L(()=>{let e=[...k.value];if(p.value){const t=p.value.toLowerCase();e=e.filter(a=>a.numero?.toString().includes(t)||a.client_nom?.toLowerCase().includes(t)||a.technicien_branchement_nom?.toLowerCase().includes(t)||a.technicien_terrassement_nom?.toLowerCase().includes(t))}return _.value.length>0&&(e=e.filter(t=>{const a=y(t);return _.value.includes(a.toLowerCase().replace(" ","_"))})),f.value.length>0&&(e=e.filter(t=>f.value.includes(t.type_prestation_code))),m.value.length>0&&(e=e.filter(t=>m.value.includes(t.technicien_branchement_nom)||m.value.includes(t.technicien_terrassement_nom))),e}),D=L(()=>p.value||_.value.length||f.value.length||m.value.length?"Aucune intervention ne correspond aux filtres sélectionnés":"Commencez par créer votre première intervention électrique"),q=async()=>{w.value=!0;try{const e=await M.get("/intervention_electrique.php?action=list");if(e.success)k.value=e.interventions||[];else throw new Error(e.message||"Erreur lors du chargement")}catch(e){A.add({severity:"error",summary:"Erreur",detail:e.message,life:5e3}),k.value=[]}finally{w.value=!1}},C=()=>{},O=()=>{p.value="",_.value=[],f.value=[],m.value=[]},P=()=>{g.push("/interventions/electrique/create")},G=e=>{g.push(`/interventions/electrique/${e}`)},H=e=>{g.push(`/interventions/electrique/${e.id}`)},Z=async e=>{g.push(`/interventions/electrique/${e}`)},J=()=>{const t=[["Numéro","Client","Type","Statut","Durée (h)","Coût total","Écart (%)","Technicien Branchement","Technicien Terrassement","Date création"].join(";"),...B.value.map(o=>[o.numero,o.client_nom,o.type_prestation_nom,y(o),o.duree_totale_heures||0,o.cout_total_reel||0,o.ecart_pourcentage||0,o.technicien_branchement_nom||"",o.technicien_terrassement_nom||"",I(o.date_creation)].map(S=>`"${S}"`).join(";"))].join(`
`),a=new Blob([t],{type:"text/csv;charset=utf-8;"}),u=document.createElement("a"),b=URL.createObjectURL(a);u.setAttribute("href",b),u.setAttribute("download",`interventions_electriques_${Date.now()}.csv`),u.style.visibility="hidden",document.body.appendChild(u),u.click(),document.body.removeChild(u),A.add({severity:"success",summary:"Export réussi",detail:"Le fichier CSV a été téléchargé",life:3e3})},y=e=>{const t=e.phase_branchement_statut==="terminee",a=!e.has_terrassement||e.phase_terrassement_statut==="terminee";return t&&a?"Terminée":e.phase_branchement_statut==="en_cours"||e.phase_terrassement_statut==="en_cours"?"En cours":e.phase_branchement_statut==="annulee"||e.phase_terrassement_statut==="annulee"?"Annulée":"En attente"},T=e=>({en_attente:"warning",en_cours:"info",terminee:"success",terminée:"success",annulee:"danger",annulée:"danger",non_applicable:"secondary"})[e?.toLowerCase()]||"secondary",K=e=>e>10?"text-red-600 dark:text-red-400":e>0?"text-orange-600 dark:text-orange-400":e<-5?"text-green-600 dark:text-green-400":"text-surface-600 dark:text-surface-400",Q=e=>R.hasPermission("technicien")&&["en_attente","en_cours"].includes(y(e).toLowerCase().replace(" ","_")),W=e=>R.hasPermission("manager")&&e.phase_branchement_statut==="terminee"&&(!e.has_terrassement||e.phase_terrassement_statut==="terminee"),X=e=>{if(!e)return"00:00";const t=Math.floor(e),a=Math.round((e-t)*60);return`${t.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`},Y=e=>e?new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(e):"-",I=e=>e?new Date(e).toLocaleDateString("fr-FR"):"-",ee=e=>e?new Date(e).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}):"-";return ue(()=>{q()}),(e,t)=>{const a=me,u=ye,b=xe,o=ve,S=he,te=ne,d=fe,E=pe,se=ae,$=re;return c(),v("div",ge,[n("div",ke,[t[5]||(t[5]=n("div",null,[n("h1",{class:"text-3xl font-bold text-surface-900 dark:text-surface-50 mb-2"}," Interventions Électriques "),n("p",{class:"text-surface-600 dark:text-surface-400"}," Gestion des interventions avec phases terrassement et branchement ")],-1)),n("div",Ce,[r(a,{label:"Nouvelle intervention",icon:"pi pi-plus",onClick:P}),r(a,{label:"Tableau de bord",icon:"pi pi-chart-pie",severity:"secondary",onClick:t[0]||(t[0]=s=>e.$router.push("/interventions/electrique/dashboard"))})])]),r(o,{class:"mb-6"},{content:l(()=>[n("div",we,[n("div",Te,[t[6]||(t[6]=n("label",{class:"text-sm font-medium text-surface-700 dark:text-surface-300"}," Recherche ",-1)),r(u,{modelValue:p.value,"onUpdate:modelValue":t[1]||(t[1]=s=>p.value=s),placeholder:"Numéro, client, technicien...",class:"w-full",onInput:C},null,8,["modelValue"])]),n("div",Se,[t[7]||(t[7]=n("label",{class:"text-sm font-medium text-surface-700 dark:text-surface-300"}," Statut ",-1)),r(b,{modelValue:_.value,"onUpdate:modelValue":t[2]||(t[2]=s=>_.value=s),options:U,"option-label":"label","option-value":"value",placeholder:"Tous les statuts",class:"w-full",onChange:C},null,8,["modelValue"])]),n("div",Ee,[t[8]||(t[8]=n("label",{class:"text-sm font-medium text-surface-700 dark:text-surface-300"}," Type ",-1)),r(b,{modelValue:f.value,"onUpdate:modelValue":t[3]||(t[3]=s=>f.value=s),options:j,"option-label":"label","option-value":"value",placeholder:"Tous les types",class:"w-full",onChange:C},null,8,["modelValue"])]),n("div",$e,[t[9]||(t[9]=n("label",{class:"text-sm font-medium text-surface-700 dark:text-surface-300"}," Technicien ",-1)),r(b,{modelValue:m.value,"onUpdate:modelValue":t[4]||(t[4]=s=>m.value=s),options:F.value,"option-label":"label","option-value":"value",placeholder:"Tous les techniciens",class:"w-full",onChange:C},null,8,["modelValue","options"])])]),n("div",Le,[r(a,{label:"Actualiser",icon:"pi pi-refresh",severity:"secondary",size:"small",onClick:q}),r(a,{label:"Exporter CSV",icon:"pi pi-download",severity:"secondary",size:"small",onClick:J}),r(a,{label:"Réinitialiser filtres",icon:"pi pi-filter-slash",severity:"secondary",size:"small",onClick:O})])]),_:1}),w.value?(c(),v("div",Ve,[r(S)])):(c(),V(o,{key:1},{content:l(()=>[r(se,{value:B.value,paginator:!0,rows:20,"rows-per-page-options":[10,20,50],"paginator-template":"RowsPerPageDropdown FirstPageLink PrevPageLink CurrentPageReport NextPageLink LastPageLink","current-page-report-template":"{first} à {last} sur {totalRecords} interventions","sort-field":"date_creation","sort-order":-1,"responsive-layout":"scroll","striped-rows":"",class:"w-full","empty-message":D.value},{empty:l(()=>[n("div",Ge,[t[10]||(t[10]=n("i",{class:"pi pi-bolt text-4xl text-surface-400 dark:text-surface-600 mb-4"},null,-1)),t[11]||(t[11]=n("h3",{class:"text-lg font-medium text-surface-700 dark:text-surface-300 mb-2"}," Aucune intervention électrique ",-1)),n("p",He,i(D.value),1),r(a,{label:"Créer une intervention",icon:"pi pi-plus",onClick:P})])]),default:l(()=>[r(d,{field:"numero",header:"N°",sortable:"",class:"min-w-[100px]"},{body:l(({data:s})=>[r(te,{to:`/interventions/electrique/${s.id}`,class:"font-mono font-bold text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-200"},{default:l(()=>[de(" #"+i(s.numero),1)]),_:2},1032,["to"])]),_:1}),r(d,{field:"client_nom",header:"Client",sortable:"",class:"min-w-[200px]"},{body:l(({data:s})=>[n("div",null,[n("div",Ne,i(s.client_nom),1),n("div",Re,i(s.type_prestation_nom),1)])]),_:1}),r(d,{header:"Phases",class:"min-w-[200px]"},{body:l(({data:s})=>[n("div",Ae,[s.has_terrassement?(c(),v("div",Be,[r(E,{value:"Terrassement",severity:T(s.phase_terrassement_statut),class:"text-xs"},null,8,["severity"]),s.technicien_terrassement_nom?(c(),v("span",De,i(s.technicien_terrassement_nom),1)):x("",!0)])):x("",!0),n("div",qe,[r(E,{value:"Branchement",severity:T(s.phase_branchement_statut),class:"text-xs"},null,8,["severity"]),s.technicien_branchement_nom?(c(),v("span",Pe,i(s.technicien_branchement_nom),1)):x("",!0)])])]),_:1}),r(d,{header:"Temps & Coût",class:"min-w-[150px]"},{body:l(({data:s})=>[n("div",Ie,[n("div",ze,i(X(s.duree_totale_heures)),1),n("div",Me,i(Y(s.cout_total_reel)),1),s.ecart_pourcentage?(c(),v("div",{key:0,class:_e(["text-xs",K(s.ecart_pourcentage)])},i(s.ecart_pourcentage>0?"+":"")+i(s.ecart_pourcentage)+"% ",3)):x("",!0)])]),_:1}),r(d,{header:"Statut",class:"min-w-[120px]"},{body:l(({data:s})=>[r(E,{value:y(s),severity:T(y(s)),class:"font-medium"},null,8,["value","severity"])]),_:1}),r(d,{field:"date_creation",header:"Créée le",sortable:"",class:"min-w-[150px]"},{body:l(({data:s})=>[n("div",Ue,[n("div",je,i(I(s.date_creation)),1),n("div",Fe,i(ee(s.date_creation)),1)])]),_:1}),r(d,{header:"Actions",class:"min-w-[120px]"},{body:l(({data:s})=>[n("div",Oe,[N(r(a,{icon:"pi pi-eye",severity:"secondary",size:"small",onClick:z=>G(s.id)},null,8,["onClick"]),[[$,"Voir détails"]]),Q(s)?N((c(),V(a,{key:0,icon:"pi pi-play",severity:"success",size:"small",onClick:z=>H(s)},null,8,["onClick"])),[[$,"Démarrer session"]]):x("",!0),W(s)?N((c(),V(a,{key:1,icon:"pi pi-check",severity:"success",size:"small",onClick:z=>Z(s.id)},null,8,["onClick"])),[[$,"Terminer"]]):x("",!0)])]),_:1})]),_:1},8,["value","empty-message"])]),_:1}))])}}},_t=be(Ze,[["__scopeId","data-v-921d1f3f"]]);export{_t as default};
